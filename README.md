
# Overview
We have a lambda for ServiceNow App Alert. Basically, this will send the ServiceNow notification through email. This lambda consist of 2 packages. One for generating the notification. Another for sending the email by 
 attaching the notification as email body.

This lambda can be triggered from another lambda in the target account. From this invoker lambda, we can pass the parameters, so that the ServiceNow lambda will generate the notification from the parameters and send
email notifications.

 [![Image](https://github.com/krishpy3/baff/raw/main/Image.jfif "Image")](https://github.com/krishpy3/baff/raw/main/Image.jfif "Image")

### Use-Case of triggering one lambda from another lambda
#### AWS Glue
AWS Glue is a fully managed extract, transform, and load (ETL) service that makes it easy to move data between data stores. You can use Lambda functions to invoke other Lambda functions as part of your ETL pipeline in AWS Glue.
Here is an example use case for a Lambda function invoking another Lambda function in an AWS Glue ETL pipeline:
1. You have data stored in an Amazon S3 bucket that you want to transform and load into an Amazon Redshift data warehouse.
2. You create an AWS Glue ETL job to extract the data from S3, transform it using a custom transformation function, and load it into Redshift.
3. The custom transformation function is implemented as a Lambda function. This function invokes another Lambda function to perform a specific task, such as calling an external API to enrich the data or applying machine learning models to the data.
4. The AWS Glue ETL job runs on a schedule, extracting and transforming the data from S3 and loading it into Redshift. As part of the transformation process, the primary Lambda function invokes the secondary Lambda function to perform the necessary task.

This is just one example of how you might use Lambda functions to invoke other Lambda functions in an AWS Glue ETL pipeline. You can use these tools to build complex data pipelines that extract, transform, and load data from a variety of sources and in a variety of formats.

#### CloudWatch Events
You can use AWS Lambda functions to invoke other Lambda functions in response to CloudWatch Events, which are a type of event that can be generated by AWS services or by custom applications. CloudWatch Events can be used to trigger a variety of actions in response to changes in your AWS resources, such as starting or stopping an Amazon EC2 instance or updating the DNS record of a domain.

One way you could use Lambda functions to respond to CloudWatch Events is by setting up an event rule in CloudWatch Events that triggers a Lambda function whenever a specific event occurs. This Lambda function could then invoke another Lambda function, which could perform some action or processing based on the data provided by the event.

For example, you might set up a CloudWatch Events rule that triggers a Lambda function whenever a new log entry is written to a specific Amazon CloudWatch Log Group. This Lambda function could then invoke another Lambda function, which could process the log data and send an alert or notification if certain conditions are met.

Overall, using Lambda functions to invoke other Lambda functions in response to CloudWatch Events can be a powerful way to automate tasks and build event-driven architectures that can respond to changes in your AWS resources.


## 1. Infrastructure setup
We have 4 cloudformation stack for this lambda setup. We will see all the stacks one by one. 
 - ServiceNow Alerting lambda should be deployed in Account A. For this, we are going to use the file from S3 Bucket. So this needs 2 cloudformation templates.
	- S3Callee CloudFormation (This will create the S3 bucket required to upload the lambda files)
	- Callee CloudFormation (In this, we will create lambda by referring the file that we uploaded in the S3Calle template)

 - ServiceNow-Invoker Lambda is to invoke our lambda in Account A, and this Invoker lambda should be deployed in Account B. As like ServiceNow Lambda, for Invoker lambda, we are using 2 stacks, one for S3 Bucket and another for Lambda. 
	- S3Caller CloudFormation
	- Caller CloudFormation

 - **S3Callee  and S3Caller Cloudformation stack**
The main purpose of this 2 cloudformation stack is to create the S3 bucket, that we can use to upload the lambda zip file. Because in lambda stack, we are not hard coding the lambda code directly into the stack. We are using S3 method as a source. So there must be one zip file with the lambda code present in S3 bucket. And this 2 lambda will help us to create those buckets in account A and B respectively.

	*Services that are provisioned under this stack*
	+ KMS key for Bucket encryption
	+ Alias Name for the KMS key for ease of use.
	+ S3 Bucket with Encryption enabled.
	+ Bucket Policy for denying UnEncrypted uploads, allowing secure transport, prevent further policy edit and object permission for the user/role.

 - **Callee CloudFormation**
As we discussed before, this stack is to create Lambda and its permissions and dependencies. This Lambda is to sending ServiceNow email notifications.

	*Services that are provisioned under this stack*
	+ Lambda (Service Now Alerting Script)
	+ IAM Role (For lambda)
	+ Policies (For the lambda&#39;s Role, this will provide permissions to CloudWatch Logs, Invoke Lambda, Ec2-VPC for accessing the Network Interface and Private IP Addresses.)
	+ Cross Account IAM Role (To be able to assume by Target lambda, inorder to trigger Service Now Alerting Lambda.
	+ Cross Account Policy (This will give permission to the cross account role to invoke the lambda)
	+ Lambda Invoke Permission
	+ LogGroup (To save lambda logs)
	+ Security Group (To enable port 2525 to gain the access from Lambda to VPC)

 - **Caller CloudFormation**
This is to create the Caller lambda function and its main task is to trigger/invoke the ServiceNow alerting lambda.  This lambda will assume the Cross Account Role in Account A, and then it will trigger the ServiceNow alerting lambda.

	*Services that are provisioned under this stack*
	+ Lambda (Service Now Invoker Script)
	+ IAM Role (For lambda)
	+ Policies (For the lambda's Role, this will provide permissions to CloudWatch Logs, Invoke Lambda)
	+ Lambda Invoke Permission.
	+ LogGroup (To save lambda logs)

## 2. Step by Step Guide for Deployment 
#### Setup S3:
We have a cloudformation templete for provisioning the S3 bucket in each account. 

##### _User should update the below data before the deployment:_
+ Name of the S3 Bucket.
+ Alias name for the Encryption key. This encryption key will be used to encrypt the data in our S3 Bucket. 
+ Policy for the Encryption key. Basically we should give 2 different policies for this KMS key. 
	+ **KMS Keys Administrator**: 
	You should give permission for someone as an admin to manage the KMS key. Admin should have all the permission for the particular key.
	
	+ **Usage Permission**: 
	Other than Admin permission, we need to provide access for a role or an user to manage the Key usage like encryption, decryption, re-encryption, generating data key and describing the key. 
+ Update Bucket policy for the below actions,
	+ Deny UnEncrypted Object Uploads
	+ Deny Insecure Connections, so it can be connected via HTTPS only.
	+ Bucket and object access for particular Users/Roles.
	+ Restricting the policy modification.
	

#### Caller Lambda
Caller lambda contains the Service Now Alerting code. The notification from the ServiceNow will be send as an email notification to the respective users from this Lambda. The data will be provided from anothor lambda (Callee lambda)

##### _User should update the below data before the deployment:_
* Lambda Function name.
* Lambda&#39;s Role name and Trust relationship should be for lambda service.
* Mention the S3 Bucket name and the Object name that you uploaded as Zip file. This zip file should contains the lambda code.
* Update the language and its version of which you used for creating the lambda function. 
* Test the script well, during the testing you can find the running time. This time you can later update in the template as timeout value.
* Create the Invoke Resource policy so that you role can gain the permission to invoke your lambda function. 
* Create one more role for the callee account, so this role can be assumed by the callee lambda and will be invoked from there.

#### Callee Lambda
Callee lambda is used for triggering the caller lambda (ServiceNow Alerting lambda). The data that we are passing to this lambda will be passed to the ServiceNow lambda, and it will generate the HTML body. That will be attached to the email body and send as an email notification.

##### _User should update the below data before the deployment:_
* Lambda Function name.
* Lambda&#39;s Role name and Trust relationship should be for lambda service.
* Mention the S3 Bucket name and the Object name that you uploaded as Zip file. This zip file should contains the lambda code.
* Update the language and its version of which you used for creating the lambda function. 
* Update the timeout value slight higer than that of the caller lambda. 
